<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆå¤§å… - äº”å­æ£‹å¯¹æˆ˜å¹³å°</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --dark-text-color: #333;
            --light-text-color: #f8f8f8;
            --border-color: #e0e0e0;
            --background-color: #f4f7f6;
            --panel-bg-color: #ffffff;
            --win-color: #27ae60;
            --loss-color: #c0392b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--dark-text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .hall-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
        }

        .panel {
            background-color: var(--panel-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }

        /* --- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯é¢æ¿ --- */
        .user-profile {
            text-align: center;
        }

        .user-profile .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 auto 15px;
            /* TODO: ç”¨æˆ·å¤´åƒå›¾ç‰‡ï¼Œå¯ä»¥é€šè¿‡JSåŠ¨æ€è®¾ç½® */
            background-image: url('https://i.pravatar.cc/100'); /* è¿™æ˜¯ä¸€ä¸ªéšæœºå¤´åƒå ä½ç¬¦ */
            background-size: cover;
            border: 4px solid var(--primary-color);
        }

        .user-profile .username {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .user-profile .score {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        .user-profile .score::before {
            content: 'ğŸ† ';
        }

        .stats {
            text-align: left;
            margin-bottom: 25px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-item .value {
            font-weight: bold;
        }

        .logout-btn {
            width: 100%;
            padding: 12px;
            background-color: #e74c3c;
            color: var(--light-text-color);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }

        /* --- ä¸­å¿ƒï¼šåŒ¹é…åŒºåŸŸ --- */
        .match-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 500px; /* ç»™ä¸€ä¸ªå›ºå®šé«˜åº¦ä»¥ä¿æŒå¸ƒå±€ç¨³å®š */
        }
        
        .match-btn {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            border: 8px solid var(--primary-color);
            background-color: var(--panel-bg-color);
            color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.4s ease;
            box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7);
        }

        .match-btn:not(.matching):hover {
            transform: scale(1.05);
            background-color: var(--primary-color);
            color: var(--light-text-color);
        }

        .match-btn.matching {
            color: #fff;
            background-color: #95a5a6;
            border-color: #7f8c8d;
            cursor: pointer; /* ä»ç„¶å¯ç‚¹å‡»ä»¥å–æ¶ˆ */
            animation: pulse 1.5s infinite;
        }
        .match-btn.matching:hover {
            background-color: #e74c3c; /* é¼ æ ‡æ‚¬åœæ—¶å˜ä¸ºå–æ¶ˆçš„çº¢è‰² */
            border-color: #c0392b;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7);
            }
            70% {
                box-shadow: 0 0 0 20px rgba(74, 144, 226, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(74, 144, 226, 0);
            }
        }

        .match-status {
            margin-top: 25px;
            font-size: 18px;
            color: #666;
            height: 25px; /* å ä½é˜²æ­¢å¸ƒå±€æŠ–åŠ¨ */
        }

        /* --- å³ä¾§ï¼šæ’è¡Œæ¦œ --- */
        .leaderboard h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .leaderboard-list {
            list-style: none;
            padding: 0;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .leaderboard-item:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }
        .leaderboard-item:hover {
            background-color: #f9f9f9;
        }
        .rank {
            font-weight: bold;
            font-size: 18px;
            width: 40px;
            text-align: center;
            color: #999;
        }
        .rank.top-1 { color: #ffd700; }
        .rank.top-2 { color: #c0c0c0; }
        .rank.top-3 { color: #cd7f32; }

        .player-name {
            flex-grow: 1;
            padding-left: 10px;
        }
        .player-score {
            font-weight: bold;
            color: var(--primary-color);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 992px) {
            .hall-container {
                grid-template-columns: 1fr;
            }
            .leaderboard {
                display: none; /* åœ¨å°å±å¹•ä¸Šå¯ä»¥å…ˆéšè—æ’è¡Œæ¦œ */
            }
            .match-area {
                height: auto;
                padding: 40px 0;
            }
        }
    </style>
</head>
<body>

<div class="hall-container">
    <!-- å·¦ä¾§ï¼šç”¨æˆ·ä¿¡æ¯ -->
    <div class="panel user-profile">
        <div class="avatar" id="user-avatar"></div>
        <div class="username" id="user-username">åŠ è½½ä¸­...</div>
        <div class="score" id="user-score">--</div>
        <div class="stats">
            <div class="stat-item">
                <span>æ€»åœºæ¬¡</span>
                <span class="value" id="user-total-count">--</span>
            </div>
            <div class="stat-item">
                <span>èƒœåœº</span>
                <span class="value" id="user-win-count">--</span>
            </div>
            <div class="stat-item">
                <span>èƒœç‡</span>
                <span class="value" id="user-win-rate">--</span>
            </div>
        </div>
        <button id="logout-btn" class="logout-btn">é€€å‡ºç™»å½•</button>
    </div>

    <!-- ä¸­å¿ƒï¼šåŒ¹é…åŒºåŸŸ -->
    <div class="panel match-area">
        <div id="match-btn" class="match-btn">å¼€å§‹åŒ¹é…</div>
        <div id="match-status" class="match-status">ç‚¹å‡»æŒ‰é’®ï¼Œå¯»æ‰¾å¯¹æ‰‹</div>
    </div>

    <!-- å³ä¾§ï¼šæ’è¡Œæ¦œ (æ­¤ä¸ºé™æ€ç¤ºä¾‹) -->
    <div class="panel leaderboard">
        <h3>ğŸ† å¤©æ¢¯æ’è¡Œæ¦œ ğŸ†</h3>
        <ul class="leaderboard-list">
            <!-- JSå¯ä»¥åŠ¨æ€ç”Ÿæˆæ­¤åˆ—è¡¨ -->
            <li class="leaderboard-item">
                <span class="rank top-1">1</span>
                <span class="player-name">æ£‹åœ£Alpha</span>
                <span class="player-score">3500</span>
            </li>
            <li class="leaderboard-item">
                <span class="rank top-2">2</span>
                <span class="player-name">ä¹æ®µæ£‹æ‰‹</span>
                <span class="player-score">3210</span>
            </li>
            <li class="leaderboard-item">
                <span class="rank top-3">3</span>
                <span class="player-name">éš”å£ç‹å”å”</span>
                <span class="player-score">3150</span>
            </li>
            <li class="leaderboard-item">
                <span class="rank">4</span>
                <span class="player-name">å¸¸èƒœå°†å†›</span>
                <span class="player-score">2800</span>
            </li>
            <li class="leaderboard-item">
                <span class="rank">5</span>
                <span class="player-name">å°èŒæ–°</span>
                <span class="player-score">2750</span>
            </li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM å…ƒç´ è·å– ---
    const usernameElem = document.getElementById('user-username');
    const scoreElem = document.getElementById('user-score');
    const totalCountElem = document.getElementById('user-total-count');
    const winCountElem = document.getElementById('user-win-count');
    const winRateElem = document.getElementById('user-win-rate');

    const matchBtn = document.getElementById('match-btn');
    const matchStatus = document.getElementById('match-status');
    
    const logoutBtn = document.getElementById('logout-btn'); // è·å–é€€å‡ºæŒ‰é’®

    let webSocket = null;
    let isMatching = false;
    
    // --- 1. è·å–å¹¶å¡«å……ç”¨æˆ·ä¿¡æ¯ ---
    async function fetchUserInfo() {
        try {
            const response = await fetch('/userInfo');
            if (response.status === 401) {
                // ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬å›ç™»å½•é¡µ
                alert('æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•ï¼');
                window.location.href = '/login.html';
                return;
            }
            const result = await response.json();
            
            if (result.resultCode === 'SUCCESS') {
                const user = result.date;
                usernameElem.textContent = user.username;
                scoreElem.textContent = user.score;
                totalCountElem.textContent = user.totalCount;
                winCountElem.textContent = user.winCount;
                const winRate = user.totalCount > 0 ? ((user.winCount / user.totalCount) * 100).toFixed(1) : 0;
                winRateElem.textContent = `${winRate}%`;
            } else {
                throw new Error(result.errMsg || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        } catch (error) {
            console.error(error);
            alert(error.message);
            window.location.href = '/login.html'; // å‡ºé”™ä¹Ÿè¿”å›ç™»å½•é¡µ
        }
    }

    // --- 2. WebSocket è¿æ¥ç®¡ç† ---
    function connectWebSocket() {
        // ä½¿ç”¨ wss:// (åŠ å¯†) æˆ– ws:// (éåŠ å¯†)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/findMatch`;

        webSocket = new WebSocket(wsUrl);

        webSocket.onopen = () => {
            console.log('WebSocket è¿æ¥æˆåŠŸï¼');
            matchBtn.disabled = false;
            matchStatus.textContent = 'å·²è¿æ¥åˆ°åŒ¹é…æœåŠ¡å™¨ï¼Œå‡†å¤‡å°±ç»ªï¼';
        };

        webSocket.onmessage = (event) => {
            const response = JSON.parse(event.data);
            console.log('æ”¶åˆ°æ¶ˆæ¯:', response);

            // æ ¹æ®ä½ çš„ WebSocketResult ç»“æ„å¤„ç†
            if (response.code === 'SUCCESS' && response.data) {
                handleSuccessMessage(response.data);
            } else if (response.code === 'FAIL' && response.data) {
                handleFailMessage(response.data);
            }
        };

        webSocket.onclose = () => {
            console.log('WebSocket è¿æ¥å·²å…³é—­ã€‚');
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¿é€»è¾‘
            matchStatus.textContent = 'ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥';
            isMatching = false;
            updateMatchButtonUI();
        };

        webSocket.onerror = (error) => {
            console.error('WebSocket é”™è¯¯:', error);
            matchStatus.textContent = 'è¿æ¥é”™è¯¯ï¼';
        };
    }
    
    function handleSuccessMessage(data) {
        if (data.message === 'startMatch') {
            isMatching = true;
            updateMatchButtonUI();
        } else if (data.message === 'stopMatch') {
            isMatching = false;
            updateMatchButtonUI();
        } else if (data.message === 'matchSuccess') {
            alert('åŒ¹é…æˆåŠŸï¼å³å°†è¿›å…¥å¯¹æˆ˜æˆ¿é—´ï¼');
            // å…³é”®ï¼šè·³è½¬åˆ°æ¸¸æˆé¡µé¢
            window.location.href = '/game.html';
        }
    }

    function handleFailMessage(data) {
        alert(`æ“ä½œå¤±è´¥: ${data.reason}`);
        isMatching = false;
        updateMatchButtonUI();
    }
    
    // --- 3. åŒ¹é…æŒ‰é’®é€»è¾‘ ---
    matchBtn.addEventListener('click', () => {
        if (!webSocket || webSocket.readyState !== WebSocket.OPEN) {
            alert('å°šæœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            return;
        }

        if (isMatching) {
            // å–æ¶ˆåŒ¹é…
            webSocket.send(JSON.stringify({ message: 'stopMatch' }));
        } else {
            // å¼€å§‹åŒ¹é…
            webSocket.send(JSON.stringify({ message: 'startMatch' }));
        }
    });

    function updateMatchButtonUI() {
        if (isMatching) {
            matchBtn.classList.add('matching');
            matchBtn.innerHTML = 'åŒ¹é…ä¸­...<br><small>ç‚¹å‡»å–æ¶ˆ</small>';
            matchStatus.textContent = 'æ­£åœ¨ä¸ºæ‚¨å¯»æ‰¾å®åŠ›ç›¸å½“çš„å¯¹æ‰‹...';
        } else {
            matchBtn.classList.remove('matching');
            matchBtn.textContent = 'å¼€å§‹åŒ¹é…';
            matchStatus.textContent = 'ç‚¹å‡»æŒ‰é’®ï¼Œå¯»æ‰¾å¯¹æ‰‹';
        }
    }
    
    // --- 4. é€€å‡ºç™»å½•é€»è¾‘ (æ–°æ·»åŠ çš„éƒ¨åˆ†) ---
    logoutBtn.addEventListener('click', () => {
        if (confirm('æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                webSocket.close();
            }
            window.location.href = '/login.html';
        }
    });

    // --- é¡µé¢åˆå§‹åŒ– ---
    async function init() {
        await fetchUserInfo();
        connectWebSocket();
    }

    init();
});
</script>
</body>
</html>